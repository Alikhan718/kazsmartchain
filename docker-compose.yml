version: "3.9"
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: kaz
      POSTGRES_PASSWORD: kazpass
      POSTGRES_DB: kazsmartchain
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  ipfs:
    image: ipfs/kubo:latest
    environment:
      IPFS_PROFILE: server
    ports:
      - "5001:5001"
      - "8080:8080"
    command: ["daemon", "--migrate=true", "--agent-version-suffix=docker"]
    volumes:
      - ipfs_staging:/export
      - ipfs_data:/data/ipfs

  firefly-mock:
    image: node:20
    working_dir: /srv
    volumes:
      - ./apps/mocks/firefly:/srv
    command: bash -lc "npm i && npm run start"
    environment:
      PORT: 5100
    ports:
      - "5100:5100"

  solana-mock:
    image: node:20
    working_dir: /srv
    volumes:
      - ./apps/mocks/solana:/srv
    command: bash -lc "npm i && npm run start"
    environment:
      PORT: 8899
    ports:
      - "8899:8899"

  api:
    image: node:20
    working_dir: /srv
    volumes:
      - ./:/srv
      - node_modules_root:/srv/node_modules
      - node_modules_api:/srv/apps/api/node_modules
      - node_modules_web:/srv/apps/web/node_modules
      - node_modules_relay:/srv/apps/relay/node_modules
    environment:
      NODE_ENV: development
      NPM_CONFIG_LEGACY_PEER_DEPS: "true"
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: kaz
      POSTGRES_PASSWORD: kazpass
      POSTGRES_DB: kazsmartchain
      REDIS_HOST: redis
      REDIS_PORT: 6379
      FIREFLY_BASE_URL: http://firefly-mock:5100
      IPFS_BASE_URL: http://ipfs:5001
      SOLANA_RPC_URL: http://solana-mock:8899
      API_PORT: 4000
      API_HOST: 0.0.0.0
      API_JWT_SECRET: dev-secret-change
    depends_on:
      - postgres
      - redis
      - ipfs
      - firefly-mock
      - solana-mock
    ports:
      - "4000:4000"
    command: bash -lc "npm i -g npm@11 && npm install --workspaces --include-workspace-root --legacy-peer-deps && npm run -w packages/sdk build && npm run -w apps/api migrate:run && npm run -w apps/api start:dev"

  relay:
    image: node:20
    working_dir: /srv
    volumes:
      - ./:/srv
      - node_modules_root:/srv/node_modules
      - node_modules_relay:/srv/apps/relay/node_modules
    environment:
      NODE_ENV: development
      REDIS_HOST: redis
      REDIS_PORT: 6379
      FIREFLY_BASE_URL: http://firefly-mock:5100
      IPFS_BASE_URL: http://ipfs:5001
      SOLANA_RPC_URL: http://solana-mock:8899
      RELAY_PORT: 4100
    depends_on:
      - redis
      - firefly-mock
    ports:
      - "4100:4100"
    command: bash -lc "while [ ! -d node_modules ]; do echo 'waiting for workspace install...'; sleep 2; done; npm run -w apps/relay start:dev"

  web:
    image: node:20
    working_dir: /srv
    volumes:
      - ./:/srv
      - node_modules_root:/srv/node_modules
      - node_modules_web:/srv/apps/web/node_modules
    environment:
      NEXT_PUBLIC_API_BASE_URL: http://localhost:4000
      NEXT_PUBLIC_SOLANA_CLUSTER: devnet
      NEXT_PUBLIC_RELAY_BASE_URL: http://localhost:4100
      PORT: 3000
    depends_on:
      - api
    ports:
      - "3000:3000"
    command: bash -lc "while [ ! -d node_modules ]; do echo 'waiting for workspace install...'; sleep 2; done; npm run -w packages/sdk build && npm run -w apps/web dev"

volumes:
  pgdata: {}
  ipfs_staging: {}
  ipfs_data: {}
  node_modules_root: {}
  node_modules_api: {}
  node_modules_web: {}
  node_modules_relay: {}

